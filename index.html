<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Centauro ED ‚Äî Next Level (Single-File)</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f1730; --card:#111c3a; --muted:#8aa0c2; --text:#eaf1ff;
      --accent:#7c5cff; --good:#2ee59d; --warn:#ffcc66; --bad:#ff5c7a; --line:#20305a;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(124,92,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 80% 0%, rgba(46,229,157,.12), transparent 50%),
                  linear-gradient(180deg, #060913, #0b1020 40%, #070a14);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:30;
      background: rgba(11,16,32,.75); backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(32,48,90,.6);
    }
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 18px;
      max-width:1500px; margin:0 auto;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, rgba(124,92,255,.9), rgba(46,229,157,.75));
      box-shadow: var(--shadow);
      position:relative;
    }
    .logo:after{
      content:""; position:absolute; inset:10px;
      border-radius:10px; border:1px solid rgba(255,255,255,.35);
      transform: rotate(12deg);
    }
    .brand h1{font-size:14px; margin:0; letter-spacing:.4px}
    .brand .sub{font-size:12px; color:var(--muted); margin-top:2px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    button, .pill{
      border:1px solid rgba(32,48,90,.9);
      background: rgba(17,28,58,.7);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s transform,.15s background,.15s border;
      display:inline-flex; gap:10px; align-items:center;
      user-select:none;
    }
    button:hover{transform: translateY(-1px); border-color: rgba(124,92,255,.55); background: rgba(17,28,58,.95)}
    button:active{transform: translateY(0px)}
    button.danger{border-color: rgba(255,92,122,.65)}
    .pill{padding:8px 10px; font-size:12px; color:var(--muted)}
    .kbd{font-family:var(--mono); font-size:11px; opacity:.9; padding:2px 6px; border-radius:8px; border:1px solid rgba(32,48,90,.9)}

    .shell{max-width:1500px; margin:0 auto; padding:16px 18px 26px}
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin: 10px 0 14px;
    }
    .tab{
      padding:10px 12px;
      border:1px solid rgba(32,48,90,.9);
      background: rgba(17,28,58,.55);
      border-radius: 14px;
      cursor:pointer;
      font-size:12px;
    }
    .tab.active{
      border-color: rgba(124,92,255,.8);
      background: rgba(124,92,255,.15);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr 1fr;
      gap:14px;
      align-items:start;
    }
    @media(max-width:1100px){.grid{grid-template-columns:1fr}}
    .panel{
      background: rgba(15,23,48,.65);
      border:1px solid rgba(32,48,90,.7);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-head{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(32,48,90,.7);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .panel-title{display:flex; flex-direction:column; gap:2px}
    .panel-title h2{margin:0; font-size:13px; letter-spacing:.3px}
    .panel-title .hint{margin:0; font-size:12px; color:var(--muted)}
    .panel-body{padding:14px}
    .card{
      background: rgba(17,28,58,.65);
      border:1px solid rgba(32,48,90,.7);
      border-radius: 16px;
      padding:12px;
    }
    .cards{display:grid; gap:12px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media(max-width:680px){.row{grid-template-columns:1fr}}
    label{display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--muted)}
    input, select, textarea{
      width:100%; border-radius:12px;
      border:1px solid rgba(32,48,90,.85);
      background: rgba(10,14,28,.6);
      color: var(--text);
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:86px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color: rgba(124,92,255,.7)}
    .tag{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(32,48,90,.9);
      color:var(--muted);
      background: rgba(10,14,28,.35);
    }
    .tags{display:flex; flex-wrap:wrap; gap:8px}
    .stepper{display:flex; gap:8px; flex-wrap:wrap}
    .step{
      padding:8px 10px; border-radius: 12px;
      border:1px solid rgba(32,48,90,.9);
      background: rgba(17,28,58,.55);
      cursor:pointer;
      display:flex; gap:8px; align-items:center;
      font-size:12px;
    }
    .step b{font-family:var(--mono); font-size:11px; color:rgba(255,255,255,.85)}
    .step.active{border-color: rgba(124,92,255,.8); background: rgba(124,92,255,.15)}
    .step.done{border-color: rgba(46,229,157,.75); background: rgba(46,229,157,.12)}
    .statusline{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .meter{
      height:8px; border-radius:999px;
      background: rgba(32,48,90,.55);
      overflow:hidden;
      border:1px solid rgba(32,48,90,.7);
    }
    .meter > div{
      height:100%;
      background: linear-gradient(90deg, rgba(124,92,255,.9), rgba(46,229,157,.7));
      width:10%;
    }
    .footerbar{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:space-between; align-items:center;
      border-top:1px solid rgba(32,48,90,.7);
      padding:12px 14px;
      background: rgba(15,23,48,.35);
    }
    .hr{height:1px; background: rgba(32,48,90,.65); margin:10px 0}
    .small{font-size:12px}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .ghost{opacity:.55}
    .check{
      display:flex; gap:10px; align-items:flex-start;
      padding:8px 10px;
      border:1px solid rgba(32,48,90,.65);
      border-radius:14px;
      background: rgba(10,14,28,.25);
    }
    .check input{margin-top:2px; width:auto}
    .check b{font-size:12px}
    .ai-box{display:grid; gap:12px}
    .ai-big{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(32,48,90,.7);
      background: rgba(17,28,58,.45);
    }
    .ai-big h3{margin:0 0 10px 0; font-size:13px}
    .ai-cols{display:grid; grid-template-columns:1fr; gap:10px}
    .ai-item{
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(32,48,90,.7);
      background: rgba(10,14,28,.35);
    }
    .ai-item .top{
      display:flex; justify-content:space-between; gap:8px; align-items:center;
      margin-bottom:8px;
    }
    .badge{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(32,48,90,.85);
      background: rgba(17,28,58,.55);
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.good{border-color: rgba(46,229,157,.55); color: rgba(46,229,157,.95); background: rgba(46,229,157,.10)}
    .badge.warn{border-color: rgba(255,204,102,.55); color: rgba(255,204,102,.95); background: rgba(255,204,102,.10)}
    .badge.bad{border-color: rgba(255,92,122,.55); color: rgba(255,92,122,.95); background: rgba(255,92,122,.10)}
    .toast{
      position:fixed; right:18px; bottom:18px; z-index:99;
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(32,48,90,.8);
      background: rgba(17,28,58,.92);
      box-shadow: var(--shadow);
      display:none;
      max-width:min(560px, 92vw);
      font-size:12px;
      color:var(--text);
    }
    .toast.show{display:block; animation: pop .18s ease-out}
    @keyframes pop{from{transform:translateY(6px); opacity:.6} to{transform:translateY(0); opacity:1}}

    /* Board / Kanban */
    .board{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media(max-width:1100px){.board{grid-template-columns:1fr 1fr}}
    @media(max-width:700px){.board{grid-template-columns:1fr}}
    .col{
      border:1px solid rgba(32,48,90,.7);
      background: rgba(17,28,58,.35);
      border-radius:16px;
      padding:10px;
      min-height: 240px;
    }
    .col h3{margin:0 0 8px 0; font-size:12px; color:var(--muted); letter-spacing:.3px}
    .pt{
      border:1px solid rgba(32,48,90,.7);
      background: rgba(10,14,28,.38);
      border-radius:14px;
      padding:10px;
      margin: 8px 0;
      cursor:pointer;
      transition:.12s transform, .12s border;
    }
    .pt:hover{transform: translateY(-1px); border-color: rgba(124,92,255,.55)}
    .pt .top{display:flex; justify-content:space-between; gap:8px; align-items:center}
    .pt .id{font-family:var(--mono); font-size:11px; color:rgba(255,255,255,.88)}
    .pt .cc{font-size:12px}
    .pt .sub{font-size:11px; color:var(--muted); margin-top:6px; display:flex; gap:8px; flex-wrap:wrap}
    .spark{
      height:6px; border-radius:999px; border:1px solid rgba(32,48,90,.7);
      background: rgba(32,48,90,.45);
      overflow:hidden;
      margin-top:8px;
    }
    .spark>div{
      height:100%;
      background: linear-gradient(90deg, rgba(255,92,122,.9), rgba(255,204,102,.7), rgba(46,229,157,.7));
      width:40%;
    }

    /* ===========================
       LEGAL GATE + COPYRIGHT (ES)
       ¬© 2025 JUAN CARLOS AMEZ RIENDAS
       (A√±adido sin modificar el resto)
       =========================== */
    #legalGate{
      position:fixed;
      inset:0;
      z-index:9999;
      background:rgba(5,8,20,.96);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    #legalGate .box{
      max-width:940px;
      width:100%;
      max-height:90vh;
      overflow:auto;
      background: rgba(15,23,48,.92);
      border:1px solid rgba(32,48,90,.85);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    #legalGate h2{margin:0 0 8px 0; font-size:14px; letter-spacing:.2px}
    #legalGate .legalhead{display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap}
    #legalGate .copy{font-size:12px; color:var(--muted)}
    #legalText{
      width:100%;
      height:320px;
      margin:10px 0;
      background: rgba(10,14,28,.65);
      color: var(--text);
      border:1px solid rgba(32,48,90,.85);
      border-radius: 14px;
      padding:12px;
      font-family: var(--mono);
      font-size:11px;
      line-height:1.35;
      resize:none;
    }
    #legalGate .checks{display:grid; gap:8px; margin-top:10px}
    #legalGate .btnrow{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px}
    #legalGate button.primary{background: rgba(124,92,255,.85)}
    #legalGate button.primary:disabled{opacity:.55}
    #legalFooter{
      position:fixed;
      left:12px;
      right:12px;
      bottom:12px;
      z-index:20;
      pointer-events:none;
      display:flex;
      justify-content:center;
    }
    #legalFooter .inner{
      pointer-events:auto;
      font-size:11px;
      color: rgba(138,160,194,.95);
      border:1px solid rgba(32,48,90,.75);
      background: rgba(15,23,48,.55);
      backdrop-filter: blur(8px);
      border-radius: 999px;
      padding:6px 10px;
      box-shadow: var(--shadow);
      text-align:center;
      max-width: min(1100px, 96vw);
    }
    #legalFooter .inner a{color:rgba(234,241,255,.9); text-decoration:underline}
  </style>
</head>
<body>

<!-- ======================================================
     BLOQUEO LEGAL OBLIGATORIO (RGPD + LOPDGDD + marco sanitario ES)
     ¬© 2025 JUAN CARLOS AMEZ RIENDAS ‚Äî Todos los derechos reservados
     (A√±adido sin modificar el resto)
     ====================================================== -->
<div id="legalGate" aria-modal="true" role="dialog">
  <div class="box">
    <div class="legalhead">
      <div>
        <h2>‚ö†Ô∏è Aviso legal y condiciones de uso</h2>
        <div class="copy"><b>¬© 2025 JUAN CARLOS AMEZ RIENDAS ‚Äî Todos los derechos reservados</b></div>
      </div>
      <div class="tag">Acceso condicionado</div>
    </div>

    <textarea id="legalText" readonly>
AVISO LEGAL Y CONDICIONES DE USO (ESPA√ëA / UE)

1) TITULARIDAD Y PROPIEDAD INTELECTUAL
El presente software ("Centauro ED ‚Äî Next Level") es propiedad intelectual de JUAN CARLOS AMEZ RIENDAS.
¬© 2025 JUAN CARLOS AMEZ RIENDAS ‚Äî Todos los derechos reservados.
Queda prohibida la reproducci√≥n, distribuci√≥n, comunicaci√≥n p√∫blica, transformaci√≥n o uso comercial total o parcial,
salvo autorizaci√≥n expresa y por escrito del titular.

2) MARCO NORMATIVO RELEVANTE
- Reglamento (UE) 2016/679 (RGPD)
- Ley Org√°nica 3/2018, de Protecci√≥n de Datos Personales y garant√≠a de los derechos digitales (LOPDGDD)
- Ley 41/2002, b√°sica reguladora de la autonom√≠a del paciente y de derechos y obligaciones en materia de informaci√≥n y documentaci√≥n cl√≠nica
- Ley 44/2003, de ordenaci√≥n de las profesiones sanitarias
- Reglamento Europeo de Inteligencia Artificial (AI Act) (aplicable seg√∫n el caso; el sistema se presenta como apoyo, no aut√≥nomo)

3) NATURALEZA DEL SISTEMA (APOYO, NO SUSTITUCI√ìN)
Centauro ED es un sistema experimental de apoyo a la toma de decisiones cl√≠nicas y a la estandarizaci√≥n del triaje.
NO realiza diagn√≥sticos m√©dicos.
NO prescribe tratamientos.
NO sustituye el criterio cl√≠nico humano.
Todas las decisiones asistenciales corresponden exclusivamente a profesionales sanitarios legalmente habilitados.

4) PROTECCI√ìN DE DATOS (RGPD + LOPDGDD)
Este software est√° dise√±ado para usarse con datos ficticios o anonimizados.
Queda expresamente prohibido introducir datos personales reales de pacientes (incluida informaci√≥n de salud)
salvo que el usuario/organizaci√≥n disponga del cumplimiento √≠ntegro del RGPD/LOPDGDD y, en su caso:
- Base jur√≠dica y deber de informaci√≥n
- Registro de actividades de tratamiento
- Evaluaci√≥n de Impacto (EIPD) cuando proceda
- Contratos/encargos y medidas de seguridad apropiadas
El usuario es el √∫nico responsable del uso de los datos introducidos.

5) RESPONSABILIDAD Y LIMITACIONES
El sistema puede contener errores, sesgos o limitaciones y no garantiza resultados cl√≠nicos.
El titular no asume responsabilidad por da√±os directos o indirectos derivados del uso del sistema,
especialmente si se utiliza en contexto asistencial real, con datos personales reales o sin validaci√≥n cl√≠nica humana.

6) EXCEPCI√ìN EDUCATIVA (USO PERMITIDO SIN PAGO)
Se autoriza el uso gratuito exclusivamente con fines educativos/formativos cuando concurran TODAS estas condiciones:
- Sin contraprestaci√≥n econ√≥mica directa o indirecta
- Sin uso asistencial real
- Con datos ficticios o anonimizados
- Manteniendo visible el copyright
Para cualquier uso distinto (incluido uso comercial o asistencial), se requiere autorizaci√≥n expresa.

7) LEGISLACI√ìN Y JURISDICCI√ìN
Estas condiciones se rigen por la legislaci√≥n espa√±ola.
Para cualquier controversia, las partes se someten a los juzgados y tribunales de Espa√±a.
    </textarea>

    <div class="checks">
      <label class="check">
        <input type="checkbox" id="acceptLegal" />
        <div>
          <b>He le√≠do y acepto las condiciones legales de uso</b>
          <div class="muted small">Sin aceptaci√≥n no se permite el acceso a la aplicaci√≥n.</div>
        </div>
      </label>
      <label class="check">
        <input type="checkbox" id="eduOnly" />
        <div>
          <b>Confirmo que el uso es exclusivamente educativo y no comercial</b>
          <div class="muted small">(Marca si aplica; se registra localmente en este navegador.)</div>
        </div>
      </label>
    </div>

    <div class="btnrow">
      <button id="enterApp" class="primary" disabled>Acceder</button>
    </div>
  </div>
</div>

<!-- Copyright persistente (discreto) -->
<div id="legalFooter">
  <div class="inner">
    ¬© 2025 <b>JUAN CARLOS AMEZ RIENDAS</b> ¬∑ Todos los derechos reservados ¬∑ RGPD ¬∑ LOPDGDD ¬∑ Sistema de apoyo (no diagn√≥stico)
    ¬∑ <a href="#" id="openLegal">Ver condiciones</a>
  </div>
</div>

<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Centauro ED ‚Äî Next Level (Single-File)</h1>
        <div class="sub">Board multipaciente ¬∑ interrupciones ¬∑ scoring ¬∑ SBAR/SOAP ¬∑ audit ¬∑ KPIs</div>
      </div>
    </div>
    <div class="actions">
      <span class="pill">Atajos: <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span> Copilot ¬∑ <span class="kbd">Ctrl</span>+<span class="kbd">S</span> guardar ¬∑ <span class="kbd">Alt</span>+<span class="kbd">‚Üê/‚Üí</span> fases</span>
      <button id="btnNew">üÜï Nuevo paciente</button>
      <button id="btnInterrupt">‚õî Interrupci√≥n</button>
      <button id="btnSave">üíæ Guardar</button>
      <button id="btnExport">üì§ Export</button>
      <button id="btnImport">üì• Import</button>
      <button id="btnReset" class="danger">üß® Reset</button>
    </div>
  </div>
</header>

<main class="shell">
  <div class="tabs">
    <div class="tab active" id="tabBoard">üß≠ Board (cola)</div>
    <div class="tab" id="tabCase">üß† Caso (flujo)</div>
    <div class="tab" id="tabAnalytics">üìà Analytics</div>
  </div>

  <div id="viewBoard">
    <div class="panel">
      <div class="panel-head">
        <div class="panel-title">
          <h2>Board multipaciente (cola realista)</h2>
          <p class="hint">Selecciona un paciente para entrar al flujo. ‚ÄúRiesgo‚Äù y ‚Äúprioridad‚Äù se recalculan con Copilot.</p>
        </div>
        <div class="tags">
          <span class="tag" id="tagBoardCount">Pacientes: ‚Äî</span>
          <span class="tag" id="tagBoardSim">Sim: ‚Äî</span>
        </div>
      </div>
      <div class="panel-body">
        <div class="board" id="boardCols"></div>
      </div>
      <div class="footerbar">
        <div class="muted small" id="boardHint">Consejo: crea 3‚Äì5 pacientes y prueba a ejecutar Copilot y moverlos por fases.</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button id="btnSimArrivals">üß™ Simular llegadas</button>
          <button id="btnSimStep">‚ñ∂Ô∏é Sim paso (1 min)</button>
          <button id="btnClearSim">üßΩ Reiniciar sim</button>
        </div>
      </div>
    </div>
  </div>

  <div id="viewCase" style="display:none;">
    <div class="statusline">
      <div class="stepper" id="stepper"></div>
      <div style="min-width:300px">
        <div class="small muted" id="gateInfo">Completitud: ‚Äî</div>
        <div class="meter"><div id="meterBar"></div></div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: case flow -->
      <section class="panel">
        <div class="panel-head">
          <div class="panel-title">
            <h2 id="leftTitle">Fase ‚Äî</h2>
            <p class="hint" id="leftHint">‚Äî</p>
          </div>
          <div class="tags">
            <span class="tag" id="caseIdTag">Paciente: ‚Äî</span>
            <span class="tag" id="roleTag">Rol: Intake</span>
            <span class="tag" id="timeTag">‚è± 00:00</span>
            <span class="tag" id="interruptTag">‚õî 0</span>
          </div>
        </div>

        <div class="panel-body">
          <div class="cards">

            <div class="card">
              <h3>Identificaci√≥n m√≠nima (demo)</h3>
              <div class="row">
                <label>Alias / ID
                  <input id="ptId" placeholder="p.ej. ED-2025-00012" />
                </label>
                <label>Edad
                  <input id="ptAge" type="number" min="0" max="120" placeholder="a√±os" />
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <label>Sexo
                  <select id="ptSex">
                    <option value="">‚Äî</option>
                    <option>F</option><option>M</option><option>Otro/No especifica</option>
                  </select>
                </label>
                <label>Motivo de consulta (ED frecuente)
                  <select id="chiefComplaint"></select>
                </label>
              </div>
            </div>

            <div class="card" id="phase1">
              <h3>Fase 1 ‚Äî Anamnesis dirigida (plantillas)</h3>
              <div class="row">
                <label>Plantilla r√°pida
                  <select id="hxTemplate">
                    <option value="libre">Libre</option>
                    <option value="opqrst">OPQRST (dolor)</option>
                    <option value="dyspnea">Disnea (r√°pido)</option>
                    <option value="neuro">Neuro/ACV (r√°pido)</option>
                    <option value="sepsis">Sepsis (r√°pido)</option>
                  </select>
                </label>
                <label>Inserta plantilla en ‚ÄúS√≠ntomas clave‚Äù
                  <button id="btnInsertTemplate">üß© Insertar</button>
                </label>
              </div>

              <div class="row" style="margin-top:10px">
                <label>Inicio y evoluci√≥n
                  <textarea id="hxOnset" placeholder="Inicio, duraci√≥n, curso, desencadenantes, contexto‚Ä¶"></textarea>
                </label>
                <label>S√≠ntomas clave / red flags (texto libre)
                  <textarea id="hxKey" placeholder="S√≠ntomas principales + negativos relevantes‚Ä¶"></textarea>
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <label>Antecedentes relevantes
                  <textarea id="hxPMH" placeholder="Cardio, respiratorio, DM, inmunosupresi√≥n‚Ä¶"></textarea>
                </label>
                <label>Medicaci√≥n / alergias
                  <textarea id="hxMeds" placeholder="Dosis si se conoce ¬∑ alergias + reacci√≥n‚Ä¶"></textarea>
                </label>
              </div>

              <div class="hr"></div>
              <div class="row">
                <div>
                  <div class="small muted">Checklist por motivo (realista)</div>
                  <div id="checklists" style="display:grid; gap:8px; margin-top:8px"></div>
                </div>
                <div>
                  <div class="check">
                    <input type="checkbox" id="ptValidate" />
                    <div>
                      <b>Validaci√≥n paciente/familia del resumen</b>
                      <div class="muted small">Marca si confirmaron el resumen (demo).</div>
                    </div>
                  </div>
                  <div class="hr"></div>
                  <div class="small muted">Notas de intake (ruido / barreras / interrupciones)</div>
                  <textarea id="scribeNotes" placeholder="Interrupciones, incertidumbres, barreras idiom√°ticas, dolor, etc."></textarea>
                </div>
              </div>
            </div>

            <div class="card" id="phase2">
              <h3>Fase 2 ‚Äî Constantes + estratificaci√≥n (qSOFA-like)</h3>
              <div class="row">
                <label>FC (lpm)
                  <input id="vHR" type="number" min="0" max="260" placeholder="p.ej. 98" />
                </label>
                <label>TA sist√≥lica (mmHg)
                  <input id="vSBP" type="number" min="0" max="260" placeholder="p.ej. 122" />
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <label>SatO‚ÇÇ (%)
                  <input id="vSpO2" type="number" min="0" max="100" placeholder="p.ej. 97" />
                </label>
                <label>Temp (¬∞C)
                  <input id="vTemp" type="number" step="0.1" min="30" max="45" placeholder="p.ej. 37.2" />
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <label>FR (rpm)
                  <input id="vRR" type="number" min="0" max="80" placeholder="p.ej. 18" />
                </label>
                <label>Estado mental (demo)
                  <select id="vAMS">
                    <option value="">‚Äî</option>
                    <option value="Normal">Normal</option>
                    <option value="Alterado">Alterado</option>
                  </select>
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <label>Glucemia (mg/dL) (opcional)
                  <input id="vGlu" type="number" min="0" max="900" placeholder="p.ej. 112" />
                </label>
                <label>Dolor (0‚Äì10) (opcional)
                  <input id="vPain" type="number" min="0" max="10" placeholder="p.ej. 7" />
                </label>
              </div>
            </div>

            <div class="card" id="phase4">
              <h3>Fase 4 ‚Äî M√©dico junior (sesgos + decisiones)</h3>
              <div class="row">
                <label>Exploraci√≥n (resumen)
                  <textarea id="jrExam" placeholder="Hallazgos + negativos relevantes‚Ä¶"></textarea>
                </label>
                <label>Sesgos/ruido detectado (check r√°pido)
                  <textarea id="jrBias" placeholder="Anchoring, availability, info incompleta, multitarea‚Ä¶"></textarea>
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <label>Pruebas complementarias (decisi√≥n humana)
                  <textarea id="jrOrders" placeholder="Anal√≠tica, ECG, Rx, TC‚Ä¶ + motivo"></textarea>
                </label>
                <label>Plan inicial (tratamiento/monitorizaci√≥n)
                  <textarea id="jrPlan" placeholder="Medidas inmediatas, analgesia, antibi√≥ticos, fluidos‚Ä¶"></textarea>
                </label>
              </div>
            </div>

            <div class="card" id="phase5">
              <h3>Fase 5 ‚Äî Integraci√≥n resultados + destino</h3>
              <div class="row">
                <label>Resultados clave (texto libre)
                  <textarea id="resultsKey" placeholder="p.ej. troponina, Hb, creatinina, Rx, ECG‚Ä¶"></textarea>
                </label>
                <label>Destino final (humano)
                  <select id="finalDisposition">
                    <option value="">‚Äî</option>
                    <option value="Alta">Alta</option>
                    <option value="Observaci√≥n">Observaci√≥n</option>
                    <option value="Ingreso">Ingreso</option>
                    <option value="UCI">UCI</option>
                  </select>
                </label>
              </div>
              <div class="check" style="margin-top:10px">
                <input type="checkbox" id="lowComplexDischarge" />
                <div>
                  <b>Alta por junior (baja complejidad)</b>
                  <div class="muted small">En real: criterios + auditor√≠a reforzada.</div>
                </div>
              </div>
            </div>

            <div class="card" id="phase6">
              <h3>Fase 6 ‚Äî Supervisi√≥n senior (paquete autom√°tico)</h3>
              <div class="row">
                <label>Paquete para senior (auto)
                  <textarea id="seniorPacket" class="mono" readonly></textarea>
                </label>
                <label>Comentario / decisi√≥n senior
                  <textarea id="srNote" placeholder="Valida / corrige / solicita m√°s‚Ä¶"></textarea>
                </label>
              </div>
              <div class="check" style="margin-top:10px">
                <input type="checkbox" id="srValidated" />
                <div>
                  <b>Senior valida ingreso / caso complejo</b>
                  <div class="muted small">Marca validaci√≥n final (demo).</div>
                </div>
              </div>
            </div>

            <div class="card">
              <h3>Resumen para HCE (SBAR / SOAP)</h3>
              <div class="row">
                <label>Formato
                  <select id="summaryMode">
                    <option value="sbar">SBAR</option>
                    <option value="soap">SOAP</option>
                  </select>
                </label>
                <label>Acciones
                  <div style="display:flex; gap:10px; flex-wrap:wrap">
                    <button id="btnGenerateSummary">üßæ Generar</button>
                    <button id="btnCopySummary">üìã Copiar</button>
                  </div>
                </label>
              </div>
              <div class="hr"></div>
              <textarea id="summaryOut" class="mono" readonly placeholder="Aqu√≠ aparecer√° el resumen listo para pegar‚Ä¶"></textarea>
            </div>

          </div>
        </div>

        <div class="footerbar">
          <div class="muted small" id="auditMini">Audit: ‚Äî</div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button id="btnBackToBoard">‚Ü©Ô∏é Volver al board</button>
            <button id="btnPrev">‚Üê Anterior</button>
            <button id="btnAI">‚ö° Ejecutar Copilot</button>
            <button id="btnNext">Siguiente ‚Üí</button>
          </div>
        </div>
      </section>

      <!-- RIGHT: Copilot + KPIs + audit -->
      <aside class="panel">
        <div class="panel-head">
          <div class="panel-title">
            <h2>Copilot (demo ‚Äúm√°s realista‚Äù)</h2>
            <p class="hint">Scoring tipo qSOFA-like + red flags + motivo + sugerencias y ‚Äúno perder‚Äù.</p>
          </div>
          <div class="tags">
            <span class="tag" id="riskTag">Riesgo: ‚Äî</span>
            <span class="tag" id="confidenceTag">Confianza: ‚Äî</span>
          </div>
        </div>
        <div class="panel-body">
          <div class="ai-box">
            <div class="ai-big">
              <h3>Prioridad sugerida</h3>
              <div class="ai-item">
                <div class="top">
                  <div><b id="triageLabel">‚Äî</b></div>
                  <span class="badge" id="triageBadge">‚Äî</span>
                </div>
                <div class="small muted" id="triageWhy">Sin datos suficientes todav√≠a.</div>
              </div>
            </div>

            <div class="ai-big">
              <h3>Hip√≥tesis (diferencial)</h3>
              <div class="ai-cols" id="dxList"></div>
            </div>

            <div class="ai-big">
              <h3>Pruebas sugeridas (b√°sicas + por riesgo)</h3>
              <div class="ai-cols" id="testsList"></div>
            </div>

            <div class="ai-big">
              <h3>UCI / escalado (si aplica)</h3>
              <div class="ai-cols" id="icuList"></div>
            </div>

            <div class="ai-big">
              <h3>KPIs del caso</h3>
              <div class="ai-item">
                <div class="small">
                  <div>‚è± Tiempo hasta Copilot: <span class="mono" id="kpiTtoAI">‚Äî</span></div>
                  <div>‚è± Tiempo hasta decisi√≥n: <span class="mono" id="kpiTtoDecision">‚Äî</span></div>
                  <div>‚õî Interrupciones: <span class="mono" id="kpiInterrupts">‚Äî</span></div>
                  <div>üìå Reconsulta 72h (demo): <select id="kpi72h"><option value="">‚Äî</option><option>S√≠</option><option>No</option></select></div>
                  <div>‚ö†Ô∏è Evento adverso evitable (demo): <select id="kpiAE"><option value="">‚Äî</option><option>S√≠</option><option>No</option></select></div>
                </div>
              </div>
            </div>

            <div class="ai-big">
              <h3>Audit trail</h3>
              <div class="ai-item">
                <div id="auditList" class="small muted">‚Äî</div>
              </div>
            </div>
          </div>
        </div>
        <div class="footerbar">
          <div class="muted small">Tip: <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span> Copilot</div>
          <button id="btnRole">üë§ Cambiar rol</button>
        </div>
      </aside>
    </div>
  </div>

  <div id="viewAnalytics" style="display:none;">
    <div class="panel">
      <div class="panel-head">
        <div class="panel-title">
          <h2>Analytics (local demo)</h2>
          <p class="hint">Resumen de cohortes en local: tiempos, prioridades, destino, interrupciones.</p>
        </div>
        <div class="tags">
          <span class="tag" id="tagCohort">Cohorte: ‚Äî</span>
        </div>
      </div>
      <div class="panel-body">
        <div class="cards">
          <div class="card">
            <h3>Tabla r√°pida</h3>
            <div class="muted small">Se genera a partir de pacientes guardados en esta sesi√≥n (localStorage).</div>
            <div class="hr"></div>
            <div id="analyticsTable" class="mono small" style="white-space:pre; overflow:auto; max-height:55vh;"></div>
          </div>
          <div class="card">
            <h3>Export cohort JSON</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button id="btnExportCohort">üì§ Export cohorte</button>
              <button id="btnWipeCohort" class="danger">üß® Borrar cohorte</button>
            </div>
          </div>
        </div>
      </div>
      <div class="footerbar">
        <div class="muted small">Nota: en real, esto ir√≠a a un data lake / BI y se cruzar√≠a con outcomes.</div>
        <button id="btnBackHome">‚Ü©Ô∏é Volver</button>
      </div>
    </div>
  </div>

</main>

<div class="toast" id="toast"></div>

<script>
/* ===========================
   Centauro ED ‚Äî Next Level (single-file demo)
   =========================== */

/*
  Fuentes para ‚Äúmotivos frecuentes ED‚Äù (conceptualmente):
  - AHRQ HCUP StatBrief (ED frequent conditions) y CDC/NCHS NHAMCS/ED factsheets, que listan abdominal pain,
    URIs, chest pain, injuries/superficial, headache, UTI, dizziness/syncope, fever, etc. (ver fuentes citadas por el asistente).
*/

const STEPS = [
  { id: "phase1", title: "Fase 1 ‚Äî Anamnesis estructurada", hint: "Plantillas + checklist por motivo ¬∑ validaci√≥n paciente/familia", role: "Intake" },
  { id: "phase2", title: "Fase 2 ‚Äî Constantes y estratificaci√≥n", hint: "Constantes + estado mental + se√±ales tipo qSOFA-like", role: "Triage" },
  { id: "phase3", title: "Fase 3 ‚Äî Copilot", hint: "Sugerencias (triaje/Dx/pruebas/no-perder/escalado)", role: "Copilot" },
  { id: "phase4", title: "Fase 4 ‚Äî M√©dico junior", hint: "Explora, corrige sesgos, valida, decide pruebas y plan", role: "Junior" },
  { id: "phase5", title: "Fase 5 ‚Äî Integraci√≥n resultados", hint: "Refina plan y destino (humano decide)", role: "Junior" },
  { id: "phase6", title: "Fase 6 ‚Äî Supervisi√≥n senior", hint: "Senior apoya casos complejos / ingresos / UCI", role: "Senior" },
];

const els = id => document.getElementById(id);
const toast = (msg) => {
  const t = els("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=>t.classList.remove("show"), 2200);
};

function nowId(prefix="ED"){
  return prefix + "-" + Date.now().toString(36).toUpperCase();
}

/* ===========================
   Motivos frecuentes ED (realistas)
   =========================== */
const ED_COMPLAINTS = {
  "Dolor abdominal": {
    tags:["frecuente","digestivo","quir√∫rgico?"],
    checklist:[
      ["location","Localizaci√≥n + migraci√≥n"],
      ["peritonism","Defensa/rebote (peritonismo)"],
      ["vomit","V√≥mitos / intolerancia"],
      ["giBleed","Sangre en heces/v√≥mito"],
      ["preg","Embarazo (si aplica) / Gineco"],
      ["surg","Cirug√≠as previas / hernias"],
      ["painMax","Dolor s√∫bito m√°ximo"],
    ],
    dx:[
      ["Gastroenteritis",0.22,"v√≥mitos/diarrea"],
      ["Apendicitis",0.20,"migraci√≥n + fiebre/leucos"],
      ["C√≥lico biliar / colecistitis",0.16,"HCD/postprandial"],
      ["Obstrucci√≥n",0.10,"distensi√≥n/ausencia de heces"],
      ["Perforaci√≥n / peritonitis",0.08,"peritonismo"],
      ["Ect√≥pico / patolog√≠a gineco (si aplica)",0.10,"dolor p√©lvico/sangrado"],
    ],
    tests:[
      ["Constantes repetidas","evoluci√≥n/seguridad"],
      ["Anal√≠tica b√°sica + orina","infecci√≥n/renal/hematuria"],
      ["Œ≤-hCG (si aplica)","descartar ect√≥pico"],
      ["Eco/TC seg√∫n sospecha","imagen dirigida"],
    ],
    safety:[
      ["No perder: peritonitis/isquemia/ect√≥pico","si dolor intenso + defensa + inestabilidad, escalado"],
    ],
  },
  "Dolor tor√°cico": {
    tags:["frecuente","tiempo-dependiente"],
    checklist:[
      ["opqrst","OPQRST completado"],
      ["sob","Disnea asociada"],
      ["syncope","S√≠ncope/pres√≠ncope"],
      ["neuro","D√©ficit neuro/edad avanzada (disecci√≥n)"],
      ["pleuritic","Pleur√≠tico (TEP/pericarditis)"],
      ["risk","Factores riesgo CV / historia previa"],
    ],
    dx:[
      ["SCA/Isquemia",0.30,"dolor opresivo + riesgo"],
      ["TEP",0.16,"disnea/pleur√≠tico/taquicardia"],
      ["Pericarditis",0.10,"posicional/pleur√≠tico"],
      ["Disecci√≥n a√≥rtica",0.06,"s√∫bito m√°ximo/deficit"],
      ["M√∫sculo-esquel√©tico",0.18,"reproducible"],
      ["ERGE",0.12,"postprandial/ardor"],
    ],
    tests:[
      ["ECG 12 derivaciones","descartar isquemia/ritmo"],
      ["Troponina seriada","seg√∫n protocolo local"],
      ["Rx t√≥rax","alternativas/complicaciones"],
      ["Anal√≠tica b√°sica","hemograma/bioqu√≠mica"],
    ],
    safety:[
      ["No perder: SCA/TEP/disecci√≥n","si red flags ‚Üí monitorizaci√≥n y m√©dico inmediato"],
    ],
  },
  "Disnea": {
    tags:["frecuente","cr√≠tico?"],
    checklist:[
      ["onset","Inicio s√∫bito vs progresivo"],
      ["wheeze","Sibilancias/asma/EPOC"],
      ["fever","Fiebre/infecci√≥n"],
      ["chestpain","Dolor tor√°cico"],
      ["edema","Ortopnea/edemas (IC)"],
      ["pleuritic","Dolor pleur√≠tico (TEP/neumo)"],
    ],
    dx:[
      ["IC/Edema agudo",0.20,"ortopnea/edemas"],
      ["Neumon√≠a",0.18,"fiebre/tos"],
      ["Asma/EPOC",0.18,"sibilancias/antecedentes"],
      ["TEP",0.12,"inicio s√∫bito/taquicardia"],
      ["Neumot√≥rax",0.06,"s√∫bito + pleur√≠tico"],
    ],
    tests:[
      ["SatO‚ÇÇ + valorar gases","gravedad"],
      ["Rx t√≥rax","neumon√≠a/edema/neumo"],
      ["ECG","ritmo/ischemia"],
      ["Anal√≠tica b√°sica","infecci√≥n/renal/etc."],
    ],
    safety:[
      ["No perder: hipoxemia/fatiga respiratoria","si SpO2 baja o FR alta ‚Üí box monitorizado"],
    ],
  },
  "Fiebre / sospecha infecci√≥n": {
    tags:["frecuente","sepsis?"],
    checklist:[
      ["focus","Foco (urinario/resp/abd/piel)"],
      ["immuno","Inmunosupresi√≥n / c√°ncer / corticoides"],
      ["sepsis","Signos sepsis: confusi√≥n/hipotensi√≥n/taquipnea"],
      ["devices","Cat√©teres/pr√≥tesis"],
      ["travel","Viajes/exposiciones"],
    ],
    dx:[
      ["Respiratorio",0.20,"tos/s√≠ntomas resp"],
      ["ITU",0.16,"s√≠ntomas urinarios"],
      ["Foco abdominal",0.12,"dolor/diarrea"],
      ["Bacteriemia/Sepsis",0.10,"inestabilidad"],
      ["Fiebre no filiada",0.10,"sin foco claro"],
    ],
    tests:[
      ["Anal√≠tica + lactato (si sospecha sepsis)","estratificar gravedad"],
      ["Uroan√°lisis/cultivo (si procede)","foco urinario"],
      ["Hemocultivos (seg√∫n criterio)","antes de antibi√≥tico si procede"],
      ["Rx t√≥rax (si resp)","foco respiratorio"],
    ],
    safety:[
      ["No perder: sepsis","qSOFA-like + lactato/protocolo local"],
    ],
  },
  "Cefalea": {
    tags:["frecuente","no perder?"],
    checklist:[
      ["thunder","Inicio s√∫bito m√°ximo (thunderclap)"],
      ["neuro","D√©ficit neuro / convulsi√≥n"],
      ["fever","Fiebre/rigidez nuca (meningitis)"],
      ["immuno","Inmunosupresi√≥n"],
      ["trauma","Trauma reciente/anticoagulaci√≥n"],
    ],
    dx:[
      ["Migra√±a/primaria",0.22,"historia similar/fotofobia"],
      ["Cefalea tensional",0.18,"opresiva/bilateral"],
      ["Hemorragia SAH",0.06,"thunderclap"],
      ["Meningitis/encefalitis",0.06,"fiebre/rigidez/AMS"],
      ["HIC/masa",0.05,"progresiva + focalidad"],
    ],
    tests:[
      ["Exploraci√≥n neuro + fondo ojo (si procede)","seguridad"],
      ["TC craneal si red flags","descartar sangrado/masa"],
      ["Punci√≥n lumbar si sospecha meningitis","seg√∫n protocolos"],
    ],
    safety:[
      ["No perder: SAH/meningitis","red flags ‚Üí escalado"],
    ],
  },
  "Trauma / lesi√≥n": {
    tags:["muy frecuente","resource-heavy"],
    checklist:[
      ["mech","Mecanismo (alta energ√≠a?)"],
      ["anticoag","Anticoagulaci√≥n/antiagregaci√≥n"],
      ["head","Trauma craneal + p√©rdida conciencia"],
      ["bleed","Sangrado activo"],
      ["neurovasc","D√©ficit neurovascular distal"],
    ],
    dx:[
      ["Contusi√≥n/esguince",0.22,"dolor localizado"],
      ["Fractura",0.14,"deformidad/dolor intenso"],
      ["TCE",0.10,"cefalea/v√≥mitos/AMS"],
    ],
    tests:[
      ["Evaluaci√≥n ABCDE","prioridad"],
      ["Rx/TC seg√∫n reglas/criterio","imagen dirigida"],
      ["Analgesia + inmovilizaci√≥n","tratamiento inicial"],
    ],
    safety:[
      ["No perder: hemorragia/TCE grave","ABCDE + escalado"],
    ],
  },
  "Mareo / s√≠ncope": {
    tags:["frecuente","alto riesgo en mayores"],
    checklist:[
      ["trueSyncope","S√≠ncope real vs pres√≠ncope"],
      ["cardiac","Dolor tor√°cico/palpitaciones"],
      ["bleed","Sangrado/dolor abdominal"],
      ["neuro","Focalidad/neuro"],
      ["orthostat","Ortostatismo/deshidrataci√≥n"],
    ],
    dx:[
      ["Vasovagal",0.16,"gatillo t√≠pico"],
      ["Arritmia",0.10,"palpitaciones/ECG"],
      ["Hipovolemia",0.10,"ortostatismo"],
      ["ACV posterior (si v√©rtigo)",0.06,"red flags neuro"],
    ],
    tests:[
      ["ECG","descartar arritmias"],
      ["Glucemia","descartar hipo"],
      ["Constantes seriadas","seguridad"],
    ],
    safety:[
      ["No perder: arritmia/hemorragia/ACV","red flags ‚Üí escalado"],
    ],
  },
  "N√°useas / v√≥mitos": {
    tags:["frecuente"],
    checklist:[
      ["dehyd","Deshidrataci√≥n"],
      ["abd","Dolor abdominal"],
      ["preg","Embarazo (si aplica)"],
      ["neuro","Cefalea intensa/neurol√≥gico"],
      ["dm","DM/posible cetoacidosis"],
    ],
    dx:[
      ["Gastroenteritis",0.18,"diarrea/contactos"],
      ["Embarazo/hiperemesis",0.10,"si aplica"],
      ["Obstrucci√≥n",0.06,"distensi√≥n"],
      ["Cetoacidosis",0.05,"DM + mal estado"],
    ],
    tests:[
      ["Glucemia/cetonas si DM","seguridad"],
      ["Anal√≠tica si deshidrataci√≥n grave","renal/electrolitos"],
    ],
    safety:[
      ["No perder: DKA/obstrucci√≥n","red flags ‚Üí escalado"],
    ],
  },
  "Alteraci√≥n del estado mental": {
    tags:["cr√≠tico?","qSOFA component"],
    checklist:[
      ["lastSeen","√öltima vez normal"],
      ["neuro","D√©ficit focal"],
      ["fever","Fiebre/infecci√≥n"],
      ["tox","Intoxicaci√≥n/medicaci√≥n"],
      ["glu","Glucemia inmediata"],
    ],
    dx:[
      ["Delirium/infecci√≥n",0.12,"fiebre/edad"],
      ["ACV",0.10,"focalidad/tiempo"],
      ["Hipoglucemia",0.08,"glu baja"],
      ["Intoxicaci√≥n",0.08,"contexto"],
    ],
    tests:[
      ["Glucemia inmediata","no perder hipo"],
      ["Exploraci√≥n neuro + TC si red flags","descartar ACV/hemorragia"],
      ["Anal√≠tica/uroan√°lisis","foco infeccioso/metab√≥lico"],
    ],
    safety:[
      ["No perder: ACV/hipoglucemia/sepsis","v√≠a r√°pida seg√∫n protocolos"],
    ],
  },
  "Infecci√≥n urinaria / disuria": {
    tags:["com√∫n"],
    checklist:[
      ["dys","Disuria/polaquiuria"],
      ["flank","Dolor lumbar/fiebre (pielonefritis)"],
      ["preg","Embarazo (si aplica)"],
      ["male","Var√≥n/complicada"],
      ["sepsis","Signos de sepsis"],
    ],
    dx:[
      ["Cistitis",0.18,"s√≠ntomas bajos"],
      ["Pielonefritis",0.10,"fiebre + flanco"],
      ["Litiasis",0.08,"dolor c√≥lico"],
    ],
    tests:[
      ["Tira orina + cultivo (si procede)","confirmaci√≥n"],
      ["Anal√≠tica si fiebre o mal estado","gravedad"],
    ],
    safety:[
      ["No perder: pielonefritis/sepsis","si fiebre + dolor flanco + inestabilidad"],
    ],
  },
  "Dolor lumbar": {
    tags:["frecuente","red flags"],
    checklist:[
      ["neuro","D√©ficit neurol√≥gico/silla de montar"],
      ["fever","Fiebre (absceso epidural)"],
      ["cancer","C√°ncer/IVDU/inmuno"],
      ["trauma","Trauma/osteoporosis"],
      ["aaa","Dolor s√∫bito en mayor (AAA)"],
    ],
    dx:[
      ["Muscular",0.22,"mec√°nico"],
      ["Hernia discal",0.10,"radicular"],
      ["AAA",0.04,"mayor + s√∫bito"],
      ["Absceso epidural",0.03,"fiebre + neuro"],
    ],
    tests:[
      ["Exploraci√≥n neuro","seguridad"],
      ["Imagen si red flags","descartar serio"],
    ],
    safety:[
      ["No perder: cauda equina/AAA/infecci√≥n","red flags ‚Üí escalado"],
    ],
  },
  "Otros": {
    tags:["vario"],
    checklist:[
      ["painMax","Dolor s√∫bito m√°ximo"],
      ["bleed","Sangrado activo"],
      ["shock","Signos de shock"],
      ["neuro","D√©ficit neurol√≥gico"],
      ["preg","Embarazo (si aplica)"],
    ],
    dx:[["Dx a determinar",0.12,"datos insuficientes"]],
    tests:[["Constantes repetidas","seguridad"],["Pruebas dirigidas","seg√∫n cl√≠nica"]],
    safety:[["No perder: inestabilidad","si constantes alteradas, escalado"]],
  }
};

/* ===========================
   Razones comunes de escalado UCI (macro-categor√≠as realistas)
   =========================== */
const ICU_REASONS = [
  {k:"Sepsis / shock s√©ptico", why:"hipotensi√≥n, lactato elevado, disfunci√≥n org√°nica, necesidad de vasopresores"},
  {k:"Insuficiencia respiratoria aguda", why:"hipoxemia, FR alta, fatiga respiratoria, ventilaci√≥n no invasiva/invasiva"},
  {k:"Shock (cualquier causa)", why:"hipotensi√≥n sostenida, signos de hipoperfusi√≥n"},
  {k:"Neurol√≥gico grave", why:"ACV grave, crisis refractaria, coma, necesidad de monitorizaci√≥n"},
  {k:"Trauma mayor / hemorragia", why:"ABC inestable, transfusi√≥n masiva, TCE grave"},
  {k:"Insuficiencia renal aguda grave", why:"oliguria/anuria, K+ alto, necesidad de terapia renal sustitutiva"},
];

/* ===========================
   Estado global: cohorte + paciente actual
   =========================== */
let cohort = null;     // {meta, patients: []}
let currentId = null;  // patient.id
let timer = null;
let sim = null;        // sim state

function defaultCohort(){
  return {
    meta:{ createdAt: Date.now(), version:"next-level-1" },
    patients: []
  };
}

function newPatient(){
  const id = nowId("PT");
  const p = {
    id,
    createdAt: Date.now(),
    stepIndex: 0,
    roleIndex: 0,
    interrupts: 0,
    interruptLog: [],
    data:{
      ptId: id,
      ptAge:"",
      ptSex:"",
      chiefComplaint:"Dolor abdominal",
      hxOnset:"",
      hxKey:"",
      hxPMH:"",
      hxMeds:"",
      checklist:{},
      ptValidate:false,
      scribeNotes:"",
      vitals:{ HR:"", SBP:"", SpO2:"", Temp:"", RR:"", AMS:"", Glu:"", Pain:"" },
      jr:{ exam:"", bias:"", orders:"", plan:"" },
      resultsKey:"",
      disposition:"",
      lowComplex:false,
      sr:{ packet:"", note:"", validated:false },
      kpi:{ reconsult72h:"", adverseEvent:"" }
    },
    ai:{ ranAt:null, triage:null, why:[], confidence:null, riskScore:null, riskBand:null, dx:[], tests:[], icu:[] },
    audit:[]
  };
  addAudit(p,"system","Nuevo paciente creado");
  cohort.patients.unshift(p);
  currentId = id;
  save();
  renderAll();
  toast("Paciente creado");
}

function getP(){
  return cohort.patients.find(x=>x.id===currentId) || null;
}

function addAudit(p, actor, action){
  p.audit.unshift({ t: Date.now(), actor, action });
  p.audit = p.audit.slice(0, 80);
}

function save(){
  localStorage.setItem("centauroED:cohort", JSON.stringify(cohort));
}

function load(){
  const raw = localStorage.getItem("centauroED:cohort");
  if(!raw) return false;
  try{
    cohort = JSON.parse(raw);
    if(!cohort?.patients) cohort = defaultCohort();
    if(!currentId && cohort.patients[0]) currentId = cohort.patients[0].id;
    return true;
  }catch(e){
    console.warn(e);
    return false;
  }
}

function resetAll(){
  localStorage.removeItem("centauroED:cohort");
  cohort = defaultCohort();
  currentId = null;
  sim = null;
  renderAll();
  toast("Reset completo");
}

/* ===========================
   Tabs
   =========================== */
function setTab(name){
  els("tabBoard").classList.toggle("active", name==="board");
  els("tabCase").classList.toggle("active", name==="case");
  els("tabAnalytics").classList.toggle("active", name==="analytics");
  els("viewBoard").style.display = name==="board" ? "block":"none";
  els("viewCase").style.display = name==="case" ? "block":"none";
  els("viewAnalytics").style.display = name==="analytics" ? "block":"none";
  if(name==="analytics") renderAnalytics();
}

els("tabBoard").onclick = ()=>setTab("board");
els("tabCase").onclick = ()=>setTab("case");
els("tabAnalytics").onclick = ()=>setTab("analytics");

/* ===========================
   UI helpers
   =========================== */
function fmtDur(ms){
  ms = Math.max(0, ms);
  const s = Math.floor(ms/1000);
  const mm = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${mm}:${ss}`;
}
function short(s, n=160){
  s = String(s||"").trim();
  if(!s) return "‚Äî";
  return s.length>n ? s.slice(0,n)+"‚Ä¶" : s;
}
function badgeForBand(band){
  if(band==="CR√çTICO") return ["bad","CR√çTICO"];
  if(band==="ALTO") return ["warn","ALTO"];
  if(band==="MEDIO") return ["warn","MEDIO"];
  if(band==="BAJO") return ["good","BAJO"];
  return ["","‚Äî"];
}

/* ===========================
   Render: board
   =========================== */
const BOARD_COLUMNS = [
  {key:"llegada", title:"Llegada / Intake (F1)"},
  {key:"triaje", title:"Triage (F2‚ÄìF3)"},
  {key:"junior", title:"Junior (F4‚ÄìF5)"},
  {key:"senior", title:"Senior / Dispo (F6)"},
];

function bandFromStep(stepIndex){
  const s = stepIndex + 1;
  if(s<=1) return "llegada";
  if(s<=3) return "triaje";
  if(s<=5) return "junior";
  return "senior";
}

function renderBoard(){
  const cols = els("boardCols");
  cols.innerHTML = "";
  const counts = {llegada:0, triaje:0, junior:0, senior:0};

  BOARD_COLUMNS.forEach(c=>{
    const div = document.createElement("div");
    div.className = "col";
    div.innerHTML = `<h3>${c.title}</h3><div id="col_${c.key}"></div>`;
    cols.appendChild(div);
  });

  cohort.patients.forEach(p=>{
    const colKey = bandFromStep(p.stepIndex);
    counts[colKey]++;

    const risk = p.ai?.riskBand || "‚Äî";
    const score = (p.ai?.riskScore ?? null);
    const progress = Math.min(100, Math.max(5, Math.round(((p.stepIndex+1)/6)*100)));
    const el = document.createElement("div");
    el.className = "pt";
    el.innerHTML = `
      <div class="top">
        <div>
          <div class="id">${p.data.ptId || p.id}</div>
          <div class="cc">${p.data.chiefComplaint || "‚Äî"}</div>
        </div>
        <span class="badge ${badgeForBand(risk)[0]}">${risk}</span>
      </div>
      <div class="sub">
        <span>Edad: ${p.data.ptAge || "‚Äî"}</span>
        <span>SpO‚ÇÇ: ${p.data.vitals?.SpO2 || "‚Äî"}</span>
        <span>TA: ${p.data.vitals?.SBP || "‚Äî"}</span>
        <span>‚õî ${p.interrupts || 0}</span>
        <span class="mono">${score!==null ? ("Score "+score) : "Score ‚Äî"}</span>
      </div>
      <div class="spark"><div style="width:${progress}%"></div></div>
    `;
    el.onclick = ()=>{
      currentId = p.id;
      save();
      renderAll();
      setTab("case");
      toast("Abierto: " + (p.data.ptId || p.id));
    };
    els("col_"+colKey).appendChild(el);
  });

  els("tagBoardCount").textContent = "Pacientes: " + cohort.patients.length;
  els("tagBoardSim").textContent = "Sim: " + (sim?.running ? "ON" : "OFF");
}

/* ===========================
   Render: case flow
   =========================== */
function renderStepper(p){
  const s = els("stepper");
  s.innerHTML = "";
  STEPS.forEach((st, idx) => {
    const div = document.createElement("div");
    div.className = "step" + (idx===p.stepIndex ? " active" : "") + (idx < p.stepIndex ? " done" : "");
    div.innerHTML = `<b>${idx+1}</b> ${st.title.split(" ‚Äî ")[1]}`;
    div.onclick = () => { p.stepIndex = idx; addAudit(p,"system","Paso ‚Üí "+(idx+1)); save(); renderAll(); };
    s.appendChild(div);
  });
}

function renderCaseHeader(p){
  const st = STEPS[p.stepIndex];
  els("leftTitle").textContent = st.title;
  els("leftHint").textContent = st.hint;
  els("caseIdTag").textContent = "Paciente: " + (p.data.ptId || p.id);
  const roles = ["Intake","Triage","Junior","Senior"];
  els("roleTag").textContent = "Rol: " + roles[p.roleIndex];
  els("interruptTag").textContent = "‚õî " + (p.interrupts||0);
}

function fillComplaintSelect(){
  const sel = els("chiefComplaint");
  sel.innerHTML = "";
  Object.keys(ED_COMPLAINTS).forEach(k=>{
    const o = document.createElement("option");
    o.value = k; o.textContent = k;
    sel.appendChild(o);
  });
}

function ensureChecklist(p){
  const cc = p.data.chiefComplaint || "Otros";
  const cfg = ED_COMPLAINTS[cc] || ED_COMPLAINTS["Otros"];
  if(!p.data.checklist[cc]) p.data.checklist[cc] = {};
  const box = els("checklists");
  box.innerHTML = "";
  cfg.checklist.forEach(([key, label])=>{
    const row = document.createElement("div");
    row.className = "check";
    const checked = !!p.data.checklist[cc][key];
    row.innerHTML = `
      <input type="checkbox" ${checked ? "checked":""} />
      <div>
        <b>${label}</b>
        <div class="muted small">${cc}</div>
      </div>
    `;
    row.querySelector("input").onchange = (e)=>{
      p.data.checklist[cc][key] = e.target.checked;
      addAudit(p,"intake","Checklist: " + label + " ‚Üí " + (e.target.checked?"S√≠":"No"));
      save(); renderCompleteness(p); renderAI(p); renderBoard();
    };
    box.appendChild(row);
  });
}

function renderInputs(p){
  els("ptId").value = p.data.ptId || "";
  els("ptAge").value = p.data.ptAge || "";
  els("ptSex").value = p.data.ptSex || "";
  els("chiefComplaint").value = p.data.chiefComplaint || "Otros";

  els("hxOnset").value = p.data.hxOnset || "";
  els("hxKey").value = p.data.hxKey || "";
  els("hxPMH").value = p.data.hxPMH || "";
  els("hxMeds").value = p.data.hxMeds || "";
  els("ptValidate").checked = !!p.data.ptValidate;
  els("scribeNotes").value = p.data.scribeNotes || "";

  els("vHR").value = p.data.vitals.HR || "";
  els("vSBP").value = p.data.vitals.SBP || "";
  els("vSpO2").value = p.data.vitals.SpO2 || "";
  els("vTemp").value = p.data.vitals.Temp || "";
  els("vRR").value = p.data.vitals.RR || "";
  els("vAMS").value = p.data.vitals.AMS || "";
  els("vGlu").value = p.data.vitals.Glu || "";
  els("vPain").value = p.data.vitals.Pain || "";

  els("jrExam").value = p.data.jr.exam || "";
  els("jrBias").value = p.data.jr.bias || "";
  els("jrOrders").value = p.data.jr.orders || "";
  els("jrPlan").value = p.data.jr.plan || "";

  els("resultsKey").value = p.data.resultsKey || "";
  els("finalDisposition").value = p.data.disposition || "";
  els("lowComplexDischarge").checked = !!p.data.lowComplex;

  els("srNote").value = p.data.sr.note || "";
  els("srValidated").checked = !!p.data.sr.validated;

  els("kpi72h").value = p.data.kpi.reconsult72h || "";
  els("kpiAE").value = p.data.kpi.adverseEvent || "";
}

function computeCompleteness(p){
  // Gate m√≠nimo razonable: id/edad/sexo/motivo + hx + vitals esenciales + (ideal) Copilot
  let score = 0, total = 12;
  const has = v => (v !== null && v !== undefined && String(v).trim().length>0);

  if(has(p.data.ptId)) score++;
  if(has(p.data.ptAge)) score++;
  if(has(p.data.ptSex)) score++;
  if(has(p.data.chiefComplaint)) score++;

  if(has(p.data.hxOnset)) score++;
  if(has(p.data.hxKey)) score++;
  if(p.data.ptValidate) score++;

  const v = p.data.vitals;
  if(has(v.HR)) score++;
  if(has(v.SBP)) score++;
  if(has(v.SpO2)) score++;
  if(has(v.RR) || has(v.Temp)) score++;

  if(p.ai?.ranAt) score++;

  const pct = Math.round((score/total)*100);
  return {score, total, pct};
}

function renderCompleteness(p){
  const {pct} = computeCompleteness(p);
  els("gateInfo").textContent = "Completitud: " + pct + "%";
  els("meterBar").style.width = Math.max(6, pct) + "%";
}

function renderAudit(p){
  const last = p.audit[0];
  els("auditMini").textContent = "Audit: " + (last ? (new Date(last.t).toLocaleTimeString() + " ¬∑ " + last.actor + " ¬∑ " + last.action) : "‚Äî");
  const list = p.audit.slice(0,12).map(e=>{
    const t = new Date(e.t).toLocaleTimeString();
    return `‚Ä¢ ${t} ¬∑ ${e.actor}: ${e.action}`;
  }).join("<br/>");
  els("auditList").innerHTML = list || "‚Äî";
}

function renderKPIs(p){
  const t0 = p.createdAt;
  els("kpiInterrupts").textContent = String(p.interrupts||0);

  const aiT = p.ai?.ranAt ? fmtDur(p.ai.ranAt - t0) : "‚Äî";
  els("kpiTtoAI").textContent = aiT;

  const decisionEvt = p.data.disposition ? p.audit.find(e=>String(e.action||"").startsWith("Destino ‚Üí")) : null;
  els("kpiTtoDecision").textContent = decisionEvt ? fmtDur(decisionEvt.t - t0) : "‚Äî";
}

function renderSeniorPacket(p){
  const v = p.data.vitals;
  const packet = [
    `# ${p.data.ptId || p.id}`,
    `Motivo: ${p.data.chiefComplaint || "‚Äî"}`,
    `Edad/Sexo: ${p.data.ptAge || "‚Äî"} / ${p.data.ptSex || "‚Äî"}`,
    `Constantes: FC ${v.HR||"‚Äî"} ¬∑ TA ${v.SBP||"‚Äî"} ¬∑ SpO2 ${v.SpO2||"‚Äî"} ¬∑ FR ${v.RR||"‚Äî"} ¬∑ T ${v.Temp||"‚Äî"} ¬∑ AMS ${v.AMS||"‚Äî"}`,
    ``,
    `Hx: ${short(p.data.hxOnset)} | ${short(p.data.hxKey)}`,
    `PMH: ${short(p.data.hxPMH)} | Meds/Alergias: ${short(p.data.hxMeds)}`,
    ``,
    `Copilot: ${p.ai?.triage || "‚Äî"} | Score ${p.ai?.riskScore ?? "‚Äî"} | Conf ${p.ai?.confidence ?? "‚Äî"}%`,
    `Red flags: ${(p.ai?.why||[]).join(" ¬∑ ") || "‚Äî"}`,
    `Top Dx: ${(p.ai?.dx||[]).slice(0,3).map(d=>d.name).join(", ") || "‚Äî"}`,
    `Pruebas sugeridas: ${(p.ai?.tests||[]).slice(0,4).map(t=>t.t).join(" | ") || "‚Äî"}`,
    ``,
    `Junior exam: ${short(p.data.jr.exam)}`,
    `Plan: ${short(p.data.jr.plan)}`,
    `Pruebas (human): ${short(p.data.jr.orders)}`,
    ``,
    `Resultados: ${short(p.data.resultsKey)}`,
    `Destino (humano): ${p.data.disposition || "‚Äî"} ${p.data.lowComplex ? "(alta baja complejidad)" : ""}`,
    `Interrupciones: ${p.interrupts||0}`,
  ].join("\n");
  p.data.sr.packet = packet;
  els("seniorPacket").value = packet;
}

/* ===========================
   Copilot: scoring m√°s realista (demo)
   =========================== */
function runCopilot(p){
  const cc = p.data.chiefComplaint || "Otros";
  const cfg = ED_COMPLAINTS[cc] || ED_COMPLAINTS["Otros"];
  const v = p.data.vitals;

  const HR = Number(v.HR||NaN);
  const SBP = Number(v.SBP||NaN);
  const SpO2 = Number(v.SpO2||NaN);
  const RR = Number(v.RR||NaN);
  const Temp = Number(v.Temp||NaN);
  const AMS = (v.AMS || "").toLowerCase(); // "alterado"
  const pain = Number(v.Pain||NaN);

  let score = 0;
  const why = [];

  // qSOFA-like signals (demo): RR>=22, SBP<=100, AMS altered
  if(!isNaN(RR) && RR >= 22){ score += 18; why.push("FR ‚â• 22 (qSOFA-like)"); }
  if(!isNaN(SBP) && SBP <= 100){ score += 22; why.push("SBP ‚â§ 100 (qSOFA-like)"); }
  if(AMS.includes("alter")){ score += 22; why.push("Estado mental alterado (qSOFA-like)"); }

  // Hypoxemia / shock-ish
  if(!isNaN(SpO2) && SpO2 < 92){ score += 20; why.push("SpO‚ÇÇ < 92"); }
  if(!isNaN(SBP) && SBP < 90){ score += 18; why.push("SBP < 90 (shock)"); }
  if(!isNaN(HR) && HR >= 130){ score += 10; why.push("FC ‚â• 130"); }

  // Fever extremes
  if(!isNaN(Temp) && Temp >= 39.0){ score += 6; why.push("Fiebre alta ‚â• 39"); }
  if(!isNaN(Temp) && Temp < 35.0){ score += 8; why.push("Hipotermia < 35"); }

  // Severe pain can be a flag (contextual)
  if(!isNaN(pain) && pain >= 9){ score += 4; why.push("Dolor muy intenso (‚â•9/10)"); }

  // ‚ÄúNoise‚Äù / operational risk
  if((p.interrupts||0) >= 3){ score += 4; why.push("‚â•3 interrupciones registradas"); }
  if(p.data.ptValidate === false){ score += 2; why.push("Resumen no validado"); }

  // Complaint base weighting (time-critical)
  if(cc==="Dolor tor√°cico") score += 6;
  if(cc==="Disnea") score += 6;
  if(cc==="Alteraci√≥n del estado mental") score += 8;
  if(cc==="Trauma / lesi√≥n") score += 4;

  score = Math.min(100, Math.max(0, score));

  let band = "BAJO";
  if(score >= 25) band = "MEDIO";
  if(score >= 45) band = "ALTO";
  if(score >= 70) band = "CR√çTICO";

  // confidence: based on completeness
  const conf = Math.round(35 + computeCompleteness(p).pct * 0.65);

  // differential: base dx + boosting by band
  const boost = (band==="CR√çTICO") ? 0.18 : (band==="ALTO" ? 0.12 : (band==="MEDIO" ? 0.06 : 0.02));
  const dx = (cfg.dx||[]).map(([name, base, rationale])=>{
    const s = Math.min(0.95, base + boost);
    return {name, score:s, rationale};
  }).sort((a,b)=>b.score-a.score).slice(0,6);

  // tests: base tests + risk-based add-ons (generic)
  let tests = (cfg.tests||[]).map(([t,r])=>({t,r}));
  if(band==="ALTO" || band==="CR√çTICO"){
    tests.unshift({t:"Monitorizaci√≥n + reevaluaci√≥n frecuente", r:"Riesgo alto ‚Üí reducir retrasos"});
  }
  if(!isNaN(SpO2) && SpO2 < 90){
    tests.unshift({t:"Oxigenoterapia (seg√∫n protocolo) + valorar gases", r:"Hipoxemia marcada"});
  }
  if((cc==="Fiebre / sospecha infecci√≥n") && (band==="ALTO" || band==="CR√çTICO")){
    tests.unshift({t:"V√≠a sepsis (seg√∫n protocolo local)", r:"Se√±ales qSOFA-like/hipotensi√≥n ‚Üí escalado"});
  }
  if(cc==="Dolor tor√°cico" && (band==="ALTO" || band==="CR√çTICO")){
    tests.unshift({t:"ECG inmediato + repetir si cl√≠nica cambia", r:"Tiempo-dependiente"});
  }

  // ICU escalation suggestions (high level)
  const icu = [];
  if(band==="CR√çTICO") icu.push({k:"Escalado inmediato", why:"Riesgo CR√çTICO por scoring (demo)"});
  if(!isNaN(SBP) && SBP < 90) icu.push({k:"Shock", why:"Hipotensi√≥n sostenida sugiere shock"});
  if(!isNaN(SpO2) && SpO2 < 90) icu.push({k:"Insuficiencia respiratoria", why:"Hipoxemia significativa"});
  if(AMS.includes("alter")) icu.push({k:"Neurol√≥gico grave / monitorizaci√≥n", why:"AMS alterado"});
  if((cc==="Fiebre / sospecha infecci√≥n") && (band==="ALTO" || band==="CR√çTICO")) icu.push({k:"Sepsis / shock s√©ptico", why:"Se√±ales qSOFA-like + infecci√≥n"});

  // Map ICU reason details
  const icuExpanded = icu.length ? icu : (band==="ALTO" ? [{k:"Valorar escalado", why:"Riesgo alto (monitorizar estrechamente)"}] : []);
  const icuFinal = icuExpanded.map(x=>{
    const ref = ICU_REASONS.find(r=>r.k===x.k);
    return {k:x.k, why: x.why + (ref ? (" ¬∑ " + ref.why) : "")};
  });

  let triage = "Prioridad BAJA (demo)";
  if(band==="MEDIO") triage = "Prioridad MEDIA (demo)";
  if(band==="ALTO") triage = "Prioridad ALTA (demo)";
  if(band==="CR√çTICO") triage = "Prioridad CR√çTICA (demo)";

  p.ai = { ranAt: Date.now(), triage, why, confidence: conf, riskScore: score, riskBand: band, dx, tests, icu: icuFinal };
  addAudit(p,"copilot","Copilot ejecutado ‚Üí " + band + " (score " + score + ")");
  save();
  renderAI(p);
  renderSeniorPacket(p);
  renderBoard();
  renderKPIs(p);
  renderCompleteness(p);
  renderAudit(p);
  toast("Copilot: " + band + " ("+score+")");
}

function renderAI(p){
  const ai = p.ai || {};
  els("riskTag").textContent = "Riesgo: " + (ai.riskBand || "‚Äî") + (ai.riskScore!=null ? (" ¬∑ "+ai.riskScore) : "");
  els("confidenceTag").textContent = "Confianza: " + (ai.confidence ? (ai.confidence+"%") : "‚Äî");

  els("triageLabel").textContent = ai.triage || "‚Äî";
  const [klass, shortBand] = ai.riskBand ? badgeForBand(ai.riskBand) : ["","‚Äî"];
  const b = els("triageBadge");
  b.className = "badge " + klass;
  b.textContent = shortBand;

  els("triageWhy").textContent = (ai.why && ai.why.length)
    ? ("Se√±ales: " + ai.why.join(" ¬∑ "))
    : "Sin datos suficientes todav√≠a.";

  const dxBox = els("dxList");
  dxBox.innerHTML = "";
  (ai.dx||[]).forEach(d=>{
    const div = document.createElement("div");
    div.className = "ai-item";
    const badge = d.score >= 0.18 ? "warn" : "good";
    div.innerHTML = `
      <div class="top">
        <div><b>${d.name}</b></div>
        <span class="badge ${badge}">${Math.round(d.score*100)}%</span>
      </div>
      <div class="small muted">Racional: ${d.rationale}</div>
    `;
    dxBox.appendChild(div);
  });
  if(!(ai.dx||[]).length) dxBox.innerHTML = `<div class="ai-item ghost"><div class="muted small">Ejecuta Copilot para ver diferencial.</div></div>`;

  const tBox = els("testsList");
  tBox.innerHTML = "";
  (ai.tests||[]).slice(0,8).forEach(t=>{
    const div = document.createElement("div");
    div.className = "ai-item";
    div.innerHTML = `
      <div class="top">
        <div><b>${t.t}</b></div>
        <span class="badge">Recomendaci√≥n</span>
      </div>
      <div class="small muted">${t.r}</div>
    `;
    tBox.appendChild(div);
  });
  if(!(ai.tests||[]).length) tBox.innerHTML = `<div class="ai-item ghost"><div class="muted small">Ejecuta Copilot para sugerencias de pruebas.</div></div>`;

  const iBox = els("icuList");
  iBox.innerHTML = "";
  (ai.icu||[]).slice(0,6).forEach(x=>{
    const div = document.createElement("div");
    div.className = "ai-item";
    div.innerHTML = `
      <div class="top">
        <div><b>${x.k}</b></div>
        <span class="badge bad">Escalado</span>
      </div>
      <div class="small muted">${x.why}</div>
    `;
    iBox.appendChild(div);
  });
  if(!(ai.icu||[]).length) iBox.innerHTML = `<div class="ai-item ghost"><div class="muted small">Sin criterios de escalado detectados (demo).</div></div>`;
}

/* ===========================
   Plantillas de anamnesis
   =========================== */
const TEMPLATES = {
  libre: "",
  opqrst:
`OPQRST:
- O (Onset): 
- P (Provocation/Palliation): 
- Q (Quality): 
- R (Radiation): 
- S (Severity 0‚Äì10): 
- T (Time course): 
Negativos relevantes (p.ej. disnea, s√≠ncope, fiebre):`,
  dyspnea:
`DISNEA (r√°pido):
- Inicio: s√∫bito / progresivo
- S√≠ntomas asociados: dolor tor√°cico / fiebre / tos / sibilancias / ortopnea
- Riesgo: TEP (inmovilizaci√≥n, cirug√≠a, c√°ncer), EPOC/asma, IC
- Negativos relevantes: hemoptisis, dolor pleur√≠tico, s√≠ncope`,
  neuro:
`NEURO/ACV (r√°pido):
- √öltima vez normal (hora): 
- D√©ficit focal: (cara/brazo/pierna/lenguaje/visi√≥n)
- Cefalea intensa s√∫bita: s√≠/no
- Convulsi√≥n: s√≠/no
- Anticoagulaci√≥n: s√≠/no`,
  sepsis:
`SEPSIS (r√°pido):
- Sospecha foco: urinario/resp/abd/piel/otro
- Escalofr√≠os: s√≠/no
- Estado mental: normal/alterado
- Diuresis: normal/disminuida
- Inmunosupresi√≥n/dispositivos: s√≠/no`,
};

/* ===========================
   Summary generator (SBAR / SOAP)
   =========================== */
function generateSummary(p, mode){
  const v = p.data.vitals;
  const common = `Paciente: ${p.data.ptId || p.id}
Motivo: ${p.data.chiefComplaint || "‚Äî"}
Edad/Sexo: ${p.data.ptAge || "‚Äî"} / ${p.data.ptSex || "‚Äî"}
Constantes: FC ${v.HR||"‚Äî"} ¬∑ TA ${v.SBP||"‚Äî"} ¬∑ SpO2 ${v.SpO2||"‚Äî"} ¬∑ FR ${v.RR||"‚Äî"} ¬∑ T ${v.Temp||"‚Äî"} ¬∑ AMS ${v.AMS||"‚Äî"}
`;

  if(mode==="soap"){
    return [
      "SOAP",
      "",
      "S (Subjective):",
      `- Inicio/Evoluci√≥n: ${short(p.data.hxOnset, 220)}`,
      `- S√≠ntomas clave: ${short(p.data.hxKey, 220)}`,
      "",
      "O (Objective):",
      `- Constantes: FC ${v.HR||"‚Äî"}, TA ${v.SBP||"‚Äî"}, SpO2 ${v.SpO2||"‚Äî"}, FR ${v.RR||"‚Äî"}, T ${v.Temp||"‚Äî"}, AMS ${v.AMS||"‚Äî"}`,
      `- Exploraci√≥n: ${short(p.data.jr.exam, 240)}`,
      `- Resultados: ${short(p.data.resultsKey, 240)}`,
      "",
      "A (Assessment):",
      `- Copilot: ${p.ai?.riskBand||"‚Äî"} (score ${p.ai?.riskScore ?? "‚Äî"})`,
      `- Diferencial: ${(p.ai?.dx||[]).slice(0,4).map(d=>d.name).join(", ") || "‚Äî"}`,
      "",
      "P (Plan):",
      `- Pruebas solicitadas: ${short(p.data.jr.orders, 240)}`,
      `- Tratamiento/plan: ${short(p.data.jr.plan, 240)}`,
      `- Destino: ${p.data.disposition || "‚Äî"}`,
    ].join("\n");
  }

  // SBAR
  return [
    "SBAR",
    "",
    "S (Situation):",
    common.trim(),
    "",
    "B (Background):",
    `- Antecedentes: ${short(p.data.hxPMH, 240)}`,
    `- Meds/Alergias: ${short(p.data.hxMeds, 240)}`,
    "",
    "A (Assessment):",
    `- Hx: ${short(p.data.hxOnset, 220)} | ${short(p.data.hxKey, 220)}`,
    `- Copilot: ${p.ai?.riskBand||"‚Äî"} (score ${p.ai?.riskScore ?? "‚Äî"}) ¬∑ Red flags: ${(p.ai?.why||[]).join(" ¬∑ ") || "‚Äî"}`,
    `- Diferencial: ${(p.ai?.dx||[]).slice(0,4).map(d=>d.name).join(", ") || "‚Äî"}`,
    `- Resultados: ${short(p.data.resultsKey, 240)}`,
    "",
    "R (Recommendation):",
    `- Sugerencias Copilot (pruebas): ${(p.ai?.tests||[]).slice(0,5).map(t=>t.t).join(" | ") || "‚Äî"}`,
    `- Plan humano: ${short(p.data.jr.plan, 240)}`,
    `- Destino propuesto/decidido: ${p.data.disposition || "‚Äî"}`,
  ].join("\n");
}

/* ===========================
   Bind inputs
   =========================== */
function bindInputs(){
  els("ptId").oninput = e => { const p=getP(); if(!p) return; p.data.ptId=e.target.value; addAudit(p,"intake","ptId actualizado"); save(); renderBoard(); renderCompleteness(p); };
  els("ptAge").oninput = e => { const p=getP(); if(!p) return; p.data.ptAge=e.target.value; addAudit(p,"intake","edad actualizada"); save(); renderBoard(); renderCompleteness(p); };
  els("ptSex").onchange = e => { const p=getP(); if(!p) return; p.data.ptSex=e.target.value; addAudit(p,"intake","sexo actualizado"); save(); renderBoard(); renderCompleteness(p); };

  els("chiefComplaint").onchange = e => {
    const p=getP(); if(!p) return;
    p.data.chiefComplaint = e.target.value;
    addAudit(p,"intake","Motivo ‚Üí " + e.target.value);
    save();
    ensureChecklist(p);
    renderBoard();
    renderCompleteness(p);
  };

  els("hxOnset").oninput = e => { const p=getP(); if(!p) return; p.data.hxOnset=e.target.value; save(); renderCompleteness(p); };
  els("hxKey").oninput = e => { const p=getP(); if(!p) return; p.data.hxKey=e.target.value; save(); renderCompleteness(p); };
  els("hxPMH").oninput = e => { const p=getP(); if(!p) return; p.data.hxPMH=e.target.value; save(); };
  els("hxMeds").oninput = e => { const p=getP(); if(!p) return; p.data.hxMeds=e.target.value; save(); };
  els("ptValidate").onchange = e => { const p=getP(); if(!p) return; p.data.ptValidate=e.target.checked; addAudit(p,"intake","Validaci√≥n paciente/familia ‚Üí "+(e.target.checked?"S√≠":"No")); save(); renderCompleteness(p); };
  els("scribeNotes").oninput = e => { const p=getP(); if(!p) return; p.data.scribeNotes=e.target.value; save(); };

  const vitMap = [["vHR","HR"],["vSBP","SBP"],["vSpO2","SpO2"],["vTemp","Temp"],["vRR","RR"],["vAMS","AMS"],["vGlu","Glu"],["vPain","Pain"]];
  vitMap.forEach(([id, key])=>{
    const el = els(id);
    const handler = ()=>{
      const p=getP(); if(!p) return;
      p.data.vitals[key] = el.value;
      save();
      renderBoard();
      renderCompleteness(p);
    };
    el.oninput = handler;
    el.onchange = handler;
  });

  els("jrExam").oninput = e => { const p=getP(); if(!p) return; p.data.jr.exam=e.target.value; save(); };
  els("jrBias").oninput = e => { const p=getP(); if(!p) return; p.data.jr.bias=e.target.value; save(); };
  els("jrOrders").oninput = e => { const p=getP(); if(!p) return; p.data.jr.orders=e.target.value; save(); };
  els("jrPlan").oninput = e => { const p=getP(); if(!p) return; p.data.jr.plan=e.target.value; save(); };

  els("resultsKey").oninput = e => { const p=getP(); if(!p) return; p.data.resultsKey=e.target.value; save(); };
  els("finalDisposition").onchange = e => {
    const p=getP(); if(!p) return;
    p.data.disposition = e.target.value;
    addAudit(p,"junior","Destino ‚Üí " + e.target.value);
    save();
    renderBoard();
    renderKPIs(p);
    renderSeniorPacket(p);
  };
  els("lowComplexDischarge").onchange = e => { const p=getP(); if(!p) return; p.data.lowComplex=e.target.checked; addAudit(p,"junior","Alta baja complejidad ‚Üí "+(e.target.checked?"S√≠":"No")); save(); };

  els("srNote").oninput = e => { const p=getP(); if(!p) return; p.data.sr.note=e.target.value; save(); };
  els("srValidated").onchange = e => { const p=getP(); if(!p) return; p.data.sr.validated=e.target.checked; addAudit(p,"senior","Validaci√≥n senior ‚Üí "+(e.target.checked?"S√≠":"No")); save(); renderBoard(); };

  els("kpi72h").onchange = e => { const p=getP(); if(!p) return; p.data.kpi.reconsult72h=e.target.value; addAudit(p,"kpi","Reconsulta 72h ‚Üí "+e.target.value); save(); };
  els("kpiAE").onchange = e => { const p=getP(); if(!p) return; p.data.kpi.adverseEvent=e.target.value; addAudit(p,"kpi","Evento adverso ‚Üí "+e.target.value); save(); };

  els("btnInsertTemplate").onclick = ()=>{
    const p=getP(); if(!p) return;
    const key = els("hxTemplate").value;
    const chunk = TEMPLATES[key] || "";
    if(!chunk){ toast("Plantilla vac√≠a"); return; }
    p.data.hxKey = (p.data.hxKey ? (p.data.hxKey + "\n\n") : "") + chunk;
    addAudit(p,"intake","Plantilla insertada: " + key);
    save();
    renderInputs(p);
    toast("Plantilla insertada");
  };

  els("btnGenerateSummary").onclick = ()=>{
    const p=getP(); if(!p) return;
    const mode = els("summaryMode").value;
    els("summaryOut").value = generateSummary(p, mode);
    addAudit(p,"system","Resumen generado ("+mode+")");
    save(); renderAudit(p);
    toast("Resumen generado");
  };
  els("btnCopySummary").onclick = async ()=>{
    const txt = els("summaryOut").value || "";
    if(!txt){ toast("Nada que copiar"); return; }
    try{ await navigator.clipboard.writeText(txt); toast("Copiado"); }
    catch(e){ toast("No se pudo copiar (permiso navegador)"); }
  };
}

/* ===========================
   Step navigation + roles + interrupts
   =========================== */
function nextStep(){
  const p=getP(); if(!p) return;
  if(p.stepIndex < STEPS.length-1){
    p.stepIndex++;
    addAudit(p,"system","Paso ‚Üí " + (p.stepIndex+1));
    save();
    renderAll();
    renderBoard();
  }
}
function prevStep(){
  const p=getP(); if(!p) return;
  if(p.stepIndex > 0){
    p.stepIndex--;
    addAudit(p,"system","Paso ‚Üí " + (p.stepIndex+1));
    save();
    renderAll();
    renderBoard();
  }
}
function setRole(){
  const p=getP(); if(!p) return;
  p.roleIndex = (p.roleIndex + 1) % 4;
  const roles = ["Intake","Triage","Junior","Senior"];
  addAudit(p,"system","Rol ‚Üí " + roles[p.roleIndex]);
  save();
  renderAll();
  toast("Rol cambiado");
}

function registerInterruption(){
  const p=getP();
  if(!p){
    toast("Abre un caso primero (board ‚Üí paciente)");
    return;
  }
  p.interrupts = (p.interrupts||0) + 1;
  p.interruptLog.push({t:Date.now(), step:p.stepIndex+1});
  addAudit(p,"system","Interrupci√≥n registrada (paso "+(p.stepIndex+1)+")");
  save();
  renderAll();
  renderBoard();
  toast("Interrupci√≥n registrada");
}

/* ===========================
   Clock
   =========================== */
function startClock(){
  if(timer) clearInterval(timer);
  timer = setInterval(()=>{
    const p=getP();
    if(!p){ els("timeTag").textContent="‚è± ‚Äî"; return; }
    els("timeTag").textContent = "‚è± " + fmtDur(Date.now() - p.createdAt);
  }, 450);
}

/* ===========================
   Board simulation (simple)
   =========================== */
function simInit(){
  sim = { running:true, t:0, arrivals:0 };
}
function simArrivals(n=3){
  if(!sim) simInit();
  for(let i=0;i<n;i++){
    newPatient();
    // randomize a bit
    const p=getP();
    const ccs = Object.keys(ED_COMPLAINTS);
    p.data.chiefComplaint = ccs[Math.floor(Math.random()*ccs.length)];
    p.data.ptAge = String( Math.floor(18 + Math.random()*70) );
    p.data.ptSex = (Math.random()<0.5) ? "F":"M";
    // some vitals
    if(Math.random()<0.6) p.data.vitals.SpO2 = String( Math.floor(88 + Math.random()*12) );
    if(Math.random()<0.6) p.data.vitals.SBP = String( Math.floor(85 + Math.random()*60) );
    if(Math.random()<0.6) p.data.vitals.RR = String( Math.floor(14 + Math.random()*18) );
    if(Math.random()<0.6) p.data.vitals.HR = String( Math.floor(70 + Math.random()*80) );
    if(Math.random()<0.3) p.data.vitals.AMS = "Alterado";
    addAudit(p,"sim","Paciente simulado");
  }
  save();
  renderAll();
  toast("Llegadas simuladas");
}
function simStepMinute(){
  if(!sim) simInit();
  sim.t += 1;
  // move some patients forward (very rough)
  cohort.patients.forEach(p=>{
    // Higher risk moves faster to triage/junior/senior
    const band = p.ai?.riskBand || "BAJO";
    const chance = band==="CR√çTICO" ? 0.55 : band==="ALTO" ? 0.35 : band==="MEDIO" ? 0.18 : 0.10;
    if(Math.random() < chance && p.stepIndex < 5) p.stepIndex++;
  });
  save();
  renderBoard();
  els("tagBoardSim").textContent = "Sim: ON";
  toast("Sim +1 min");
}
function simClear(){
  sim = null;
  toast("Sim reiniciada");
  renderBoard();
}

/* ===========================
   Analytics (cohort)
   =========================== */
function renderAnalytics(){
  const rows = cohort.patients.map(p=>{
    const tAI = p.ai?.ranAt ? (p.ai.ranAt - p.createdAt) : null;
    const decisionEvt = p.data.disposition ? p.audit.find(e=>String(e.action||"").startsWith("Destino ‚Üí")) : null;
    const tDecision = decisionEvt ? (decisionEvt.t - p.createdAt) : null;
    return {
      id: p.data.ptId || p.id,
      cc: p.data.chiefComplaint || "‚Äî",
      age: p.data.ptAge || "‚Äî",
      band: p.ai?.riskBand || "‚Äî",
      score: p.ai?.riskScore ?? "‚Äî",
      tAI: tAI==null ? "‚Äî" : fmtDur(tAI),
      tDecision: tDecision==null ? "‚Äî" : fmtDur(tDecision),
      dispo: p.data.disposition || "‚Äî",
      interrupts: p.interrupts || 0
    };
  });

  els("tagCohort").textContent = "Cohorte: " + rows.length;

  const header = ["ID","Motivo","Edad","Riesgo","Score","TtoAI","TtoDec","Destino","‚õî"].join("\t");
  const body = rows.map(r=>[r.id,r.cc,r.age,r.band,r.score,r.tAI,r.tDecision,r.dispo,r.interrupts].join("\t")).join("\n");
  els("analyticsTable").textContent = header + "\n" + body;
}

function exportCohort(){
  const blob = new Blob([JSON.stringify(cohort, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `centauro_cohort_${Date.now()}.json`;
  a.click();
  toast("Cohorte exportada");
}
function wipeCohort(){
  cohort = defaultCohort();
  currentId = null;
  save();
  renderAll();
  toast("Cohorte borrada");
}

/* ===========================
   Render all
   =========================== */
function renderCase(p){
  renderStepper(p);
  renderCaseHeader(p);
  renderInputs(p);
  ensureChecklist(p);
  renderAI(p);
  renderSeniorPacket(p);
  renderKPIs(p);
  renderCompleteness(p);
  renderAudit(p);
}

function renderAll(){
  renderBoard();

  const p = getP();
  if(p){
    renderCase(p);
  }else{
    // if no current patient, show board
    setTab("board");
  }

  // buttons enable/disable
  els("btnBackToBoard").disabled = !p;
}

function init(){
  if(!load()){
    cohort = defaultCohort();
  }
  fillComplaintSelect();
  bindInputs();
  startClock();

  // top buttons
  els("btnNew").onclick = ()=>{ newPatient(); setTab("case"); };
  els("btnSave").onclick = ()=>{ save(); toast("Guardado"); };
  els("btnExport").onclick = ()=>{
    const blob = new Blob([JSON.stringify(cohort, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `centauro_full_${Date.now()}.json`;
    a.click();
    toast("Exportado");
  };
  els("btnImport").onclick = ()=>{
    const input = document.createElement("input");
    input.type="file"; input.accept="application/json";
    input.onchange = ()=>{
      const file=input.files[0]; if(!file) return;
      const r=new FileReader();
      r.onload=()=>{
        try{
          cohort = JSON.parse(r.result);
          if(!cohort?.patients) cohort = defaultCohort();
          currentId = cohort.patients[0]?.id || null;
          save();
          renderAll();
          toast("Importado");
        }catch(e){ toast("Error importando"); }
      };
      r.readAsText(file);
    };
    input.click();
  };
  els("btnReset").onclick = resetAll;
  els("btnRole").onclick = setRole;
  els("btnInterrupt").onclick = registerInterruption;

  // case navigation
  els("btnPrev").onclick = prevStep;
  els("btnNext").onclick = nextStep;
  els("btnAI").onclick = ()=>{ const p=getP(); if(p) runCopilot(p); };
  els("btnBackToBoard").onclick = ()=>setTab("board");

  // board sim
  els("btnSimArrivals").onclick = ()=>simArrivals(3);
  els("btnSimStep").onclick = simStepMinute;
  els("btnClearSim").onclick = simClear;

  // analytics buttons
  els("btnExportCohort").onclick = exportCohort;
  els("btnWipeCohort").onclick = wipeCohort;
  els("btnBackHome").onclick = ()=>setTab("board");

  // keyboard shortcuts
  window.addEventListener("keydown", (e)=>{
    if(e.ctrlKey && e.key==="Enter"){ e.preventDefault(); const p=getP(); if(p) runCopilot(p); }
    if(e.ctrlKey && e.key.toLowerCase()==="s"){ e.preventDefault(); save(); toast("Guardado"); }
    if(e.altKey && e.key==="ArrowRight"){ e.preventDefault(); nextStep(); }
    if(e.altKey && e.key==="ArrowLeft"){ e.preventDefault(); prevStep(); }
  });

  // default: if no patients, create one
  if(!cohort.patients.length){
    newPatient();
    setTab("board");
  }

  renderAll();
}
init();
</script>

<!-- ======================================================
     COPYRIGHT / AVISO PERMANENTE
     (A√±adido sin modificar el resto)
     ====================================================== -->
<div id="legalFooter">
  <div class="inner">
    ¬© 2025 <b>JUAN CARLOS AMEZ RIENDAS</b> ¬∑ Todos los derechos reservados ¬∑
    Sistema de apoyo a la decisi√≥n cl√≠nica (demo) ¬∑ RGPD ¬∑ LOPDGDD ¬∑
    <a href="#" id="openLegal">Aviso legal</a>
  </div>
</div>

<script>
/* ======================================================
   LEGAL GATE (bloqueo hasta aceptaci√≥n)
   (A√±adido sin modificar el resto)
   ====================================================== */
(function(){
  const gate = document.getElementById('legalGate');
  if(!gate) return;

  const accept = document.getElementById('acceptLegal');
  const edu = document.getElementById('eduOnly');
  const enter = document.getElementById('enterApp');
  const open = document.getElementById('openLegal');

  const KEY = 'centauroED:legalAccepted';
  const EDU = 'centauroED:eduOnly';

  function show(){ gate.style.display = 'flex'; }
  function hide(){ gate.style.display = 'none'; }

  if(localStorage.getItem(KEY)==='yes'){
    hide();
  }else{
    show();
  }

  function update(){
    enter.disabled = !(accept && accept.checked);
  }

  accept && (accept.onchange = update);
  edu && (edu.onchange = update);
  update();

  enter && (enter.onclick = ()=>{
    if(!(accept && accept.checked)) return;
    localStorage.setItem(KEY,'yes');
    localStorage.setItem(EDU,(edu && edu.checked) ? 'yes' : 'no');
    hide();
    try{ (window.toast||(()=>{}))('Condiciones aceptadas'); }catch(e){}
  });

  open && (open.onclick = (e)=>{
    e.preventDefault();
    show();
    const txt = document.getElementById('legalText');
    if(txt) txt.scrollTop = 0;
  });
})();
</script>
</body>
</html>
